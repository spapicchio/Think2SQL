# --------------------- Custom params ---------------------
prompt_folder: prompts
user_prompt_name: base_think_user_prompt.jinja
system_prompt_name: base_think_system_prompt.jinja
add_sample_rows_strategy: 'inline'  # Available: 'none', 'inline', 'append'
cache_db_connections_path: '.think2sql_cache'
target_sql_cache_db_path: '.think2sql_cache/target_cached_query.sqlite'
pred_sql_cache_db_path: '.think2sql_cache/pred_cached_query.sqlite'
# ---------------------  Important params ---------------------
num_train_epochs: 4
per_device_train_batch_size: 4 # num_of_generations must be divisible by per_device_train_batch_size
num_generations: 16

learning_rate: 1.0e-06
max_prompt_length: 3000
max_completion_length: 4096
mask_truncated_completions: true  # When enabled, truncated completions are excluded from the loss calculation
gradient_accumulation_steps: 32
# ---------------------  New Params ---------------------
loss_type: dr_grpo  # Available: 'grpo', 'dr_grpo', 'dapo', 'bnpo'
beta: 0.0 # KL coefficient. If 0.0 (default), the reference model is not loaded, reducing memory usage and improving training speed.
delta: null  #  Enables the upper clipping bound in two-sided GRPO loss when set to a float
epsilon_high: null  # Upper clipping bound for GRPO loss Paper DAPO recommends 0.28.
importance_sampling_level: 'token' # Controls whether importance sampling ratios are computed at the "token" or "sequence" level. "token" keeps the raw per-token log-probability ratios (one weight per token). "sequence" averages the log-probability ratios across valid tokens to produce a single ratio per sequence. The GSPO paper shows that sequence-level sampling often yields more stable training and better alignment with sequence-level rewards.
scale_rewards: 'group' # 'group' standard deviation each group, 'batch' standard deviation across the batch, 'none' no scaling; 'False' no scaling is applied
sync_ref_model: false  # When enabled, the reference model is updated to match the current model at the end of each training epoch.
ref_model_mixup_alpha: 0.6  # Alpha parameter for Beta distribution used in reference model mixup. Only relevant if sync_ref_model is True.
ref_model_sync_steps: 512 # Number of steps between reference model syncs. Only relevant if sync_ref_model is True.
top_entropy_quantile: 1.0  # Proportion of samples to use for entropy calculation. 1.0 uses all samples, 0.5 uses the top 50% most uncertain samples, etc.
# ----------------------------------------------------------


#####################
# MODEL ARGUMENTS
#####################
model_name_or_path: Qwen/Qwen2.5-Coder-7B-Instruct
model_revision: main
dtype: bfloat16
attn_implementation: flash_attention_2
output_dir: null  # If the model is present, the training will resume from the last checkpoint


#####################
# DATASET ARGUMENTS
#####################
dataset_name: 'simone-papicchio/bird'
dataset_train_split: train
relative_db_base_path: 'data/bird/train_databases'


#####################
# TRAINING ARGUMENTS
#####################
resume_from_checkpoint: false
bf16: true
do_eval: false
eval_strategy: "no"
use_vllm: true
vllm_gpu_memory_utilization: 0.7
vllm_server_host: 127.0.0.1
vllm_server_port: 24879

gradient_checkpointing: true
gradient_checkpointing_kwargs:
  use_reentrant: false
log_completions: false
log_level: info
logging_first_step: true
logging_steps: 1
logging_strategy: steps
lr_scheduler_type: constant_with_warmup
max_grad_norm: 0.2
max_steps: -1
overwrite_output_dir: false
push_to_hub: false
report_to:
  - wandb
reward_funcs:
  - EX
  - format
  - tag_count
reward_weights:
  - 1.0
  - 0.1
  - 0.1
save_strategy: "steps"
save_steps: 5
save_total_limit: 1
seed: 42
temperature: 0.7
optim: adamw_8bit
wandb_entity: spapicchio-politecnico-di-torino
wandb_project: think2sql
warmup_ratio: 0.1