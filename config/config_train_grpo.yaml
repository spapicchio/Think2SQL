# --------------------- Custom params ---------------------
prompt_folder: prompts
user_prompt_name: base_think_user_prompt.jinja
system_prompt_name: base_think_system_prompt.jinja

cache_db_connections_path: '.think2sql_cache'
target_sql_cache_db_path: '.think2sql_cache/target_cached_query.sqlite'
pred_sql_cache_db_path: '.think2sql_cache/pred_cached_query.sqlite'
enable_thinking_mode: 'false'
# ---------------------  Important params ---------------------
num_train_epochs: 4
per_device_train_batch_size: 4 # num_of_generations must be divisible by per_device_train_batch_size
num_generations: 16

learning_rate: 1.0e-06
max_prompt_length: 6000
max_completion_length: 4096
mask_truncated_completions: false  # When enabled, truncated completions are excluded from the loss calculation
gradient_accumulation_steps: 32
# ---------------------  New Params ---------------------
loss_type: 'dapo'  # Available: 'grpo', 'dr_grpo', 'dapo', 'bnpo'
beta: 0.0 # KL coefficient. If 0.0 (default), the reference model is not loaded, reducing memory usage and improving training speed.
delta: null  #  Enables the upper clipping bound in two-sided GRPO loss when set to a float
importance_sampling_level: 'sequence' # Controls whether importance sampling ratios are computed at the "token" or "sequence" level. "token" keeps the raw per-token log-probability ratios (one weight per token). "sequence" averages the log-probability ratios across valid tokens to produce a single ratio per sequence. The GSPO paper shows that sequence-level sampling often yields more stable training and better alignment with sequence-level rewards.
scale_rewards: 'batch' # 'group' standard deviation each group, 'batch' standard deviation across the batch, 'none' no scaling; 'False' no scaling is applied
sync_ref_model: false  # When enabled, the reference model is updated to match the current model at the end of each training epoch.
epsilon_high: 0.28  # Upper clipping bound for GRPO loss
# ----------------------------------------------------------


#####################
# MODEL ARGUMENTS
#####################
model_name_or_path: Qwen/Qwen2.5-Coder-7B-Instruct
model_revision: main
dtype: bfloat16
attn_implementation: flash_attention_2
output_dir: null  # If the model is present, the training will resume from the last checkpoint


#####################
# DATASET ARGUMENTS
#####################
dataset_name: 'simone-papicchio/bird'
dataset_train_split: train
relative_db_base_path: 'data/bird/train_databases'


#####################
# TRAINING ARGUMENTS
#####################
resume_from_checkpoint: true
bf16: true
do_eval: false
eval_strategy: "no"
use_vllm: true
vllm_gpu_memory_utilization: 0.85
vllm_server_host: 127.0.0.1
vllm_server_port: 24879

gradient_checkpointing: true
gradient_checkpointing_kwargs:
  use_reentrant: false

log_level: info
logging_first_step: true
logging_steps: 1
logging_strategy: steps
wandb_log_unique_prompts: true
log_completions: true
num_completions_to_print: 0

lr_scheduler_type: constant_with_warmup

max_grad_norm: 0.2
max_steps: -1
overwrite_output_dir: false
push_to_hub: false
report_to:
  - wandb
reward_funcs:
  - EX
  - format
reward_weights:
  - 0.85
  - 0.15
save_strategy: "steps"
save_steps: 50
save_total_limit: 2
seed: 42


# https://huggingface.co/Qwen/Qwen2.5-Coder-7B-Instruct/blob/main/generation_config.json
temperature: 0.6        # vendor default
top_p: 0.95              # vendor default (add this; itâ€™s in the model config)
top_k: 20               # vendor default
repetition_penalty: 1.1 # vendor default
# optim: adamw_8bit
wandb_entity: spapicchio-politecnico-di-torino
wandb_project: think2sql-qwen3
warmup_ratio: 0.1